<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <link rel="icon" href="/assets/imgs/icon.png" />
    <title>年会抽奖程序</title>
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/animate.css" />
  </head>
  <body>
    <h1 class="title">SF 实验室 2024 年会抽奖</h1>
    <section id="curtain">
      <!-- 大幕 -->
      <div id="curtain-top" class="curtain"></div>
      <div id="curtain-bottom" class="curtain"></div>

      <!-- 中奖卡片容器 -->
      <div id="winners-container">
        <div id="close-winner-list">
          <svg t="1705913660137" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1446" width="32" height="32"><path d="M512 512m-512 0a512 512 0 1 0 1024 0 512 512 0 1 0-1024 0Z" fill="#F55300" p-id="1447"></path><path d="M258.56 358.912l434.432 434.432a51.2 51.2 0 0 0 72.3968-72.3968L330.9568 286.5152A51.2 51.2 0 1 0 258.56 358.912z" fill="#F9F9F9" p-id="1448"></path><path d="M258.56 712.192l434.432-434.432a51.2 51.2 0 0 1 72.448 72.3968l-434.4832 434.432A51.2 51.2 0 1 1 258.56 712.192z" fill="#F9F9F9" p-id="1449"></path></svg>
        </div>
        <div id="winner-list"></div>
      </div>
    </section>
    <canvas id="canvas"></canvas>
    <div id="container">
      <!-- 选中菜单结构 start-->
      <div id="menu">
        <button id="lottery">开始抽奖</button>
      </div>
      <!-- end -->
    </div>
    <section id="prize-panel" class="shine">
      <span class="line-1"></span>
      <span class="line-2"></span>
      <span class="line-3"></span>
      <span class="line-4"></span>
      <img id="prize-img" class="prize-img" src="images/jbl.png" alt="prize" />
      <div class="prize-info">
        <div id="prize-name" class="prize-name">科沃斯扫地机器人</div>
        <div id="prize-count" class="prize-count">数量: 8个</div>
        <div id="prize-stage" class="prize-stage">第1轮</div>
      </div>
    </section>
    <section id="show-prize-panel">
      <svg t="1705996547396" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3275" id="mx_n_1705996547397" width="48" height="48"><path d="M996.730961 0a25.688693 25.688693 0 0 1 25.704819 25.704819v971.130961a25.688693 25.688693 0 0 1-25.704819 25.704818H528.609764a25.688693 25.688693 0 0 1-25.704819-25.704818 25.688693 25.688693 0 0 1 25.704819-25.704819h442.819527V51.2H51.52252v439.900724c0 14.005417-11.707465 25.495181-25.704819 25.495182a25.462929 25.462929 0 0 1-25.495181-25.495182V25.495181C0.314457 11.497827 11.602646 0 25.801575 0h970.921323zM0.104819 996.626142h0.209638v-355.900473c0-14.206992 11.288189-25.696756 25.495181-25.696756H381.702047a25.688693 25.688693 0 0 1 25.704819 25.704819v355.89241a25.688693 25.688693 0 0 1-25.704819 25.704819H25.6c-14.005417 0-25.495181-11.497827-25.495181-25.704819z m51.2-330.397229v304.902048h304.902047V666.228913H51.304819zM465.92 556.507717a25.479055 25.479055 0 0 1 0-36.154457l289.856504-289.646866H588.8a25.688693 25.688693 0 0 1-25.704819-25.704819 25.688693 25.688693 0 0 1 25.704819-25.704819h228.827717a25.688693 25.688693 0 0 1 25.712881 25.704819V433.627717a25.688693 25.688693 0 0 1-25.704818 25.704818 25.688693 25.688693 0 0 1-25.704819-25.704818V266.64315l-289.646867 289.864567a25.454866 25.454866 0 0 1-18.182047 7.522771c-6.692283 0-13.166866-2.507591-18.182047-7.522771z" fill="#7FFFFF" p-id="3276"></path></svg>
    </section>
    <section id="extra-panel" class="shine">
      <span class="line-1"></span>
      <span class="line-2"></span>
      <span class="line-3"></span>
      <span class="line-4"></span>
      <div class="extra-info">
        <div class="extra-item" id="reset-lottery">
          <svg t="1705998770475" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5534" id="mx_n_1705998770476" width="48" height="48"><path d="M0 446.56409h446.820074V0H0zM74.523342 74.523342h297.805387v297.517405H74.523342zM577.11593 1023.936004H1023.936004V577.371914H577.11593z m74.491345-372.040747h297.805387v297.517405h-297.805387z m210.482844-343.562528l-37.245672-40.669458-52.348728 48.63696 121.720392 130.263859 13.375165-12.511218 38.109618-35.83776 10.815324-10.23936L1023.936004 325.131679l-48.63696-52.348728-36.701706 33.27792-1.983876-5.695644-3.423786-10.23936C879.241047 140.631211 749.777139 30.750078 592.058996 5.727642l-2.463846-0.31998v75.099306a362.505343 362.505343 0 0 1 271.631023 225.361915l0.831948 2.463846zM161.845885 721.010937l37.245672 40.669458 52.348728-48.63696-120.888444-130.263859-13.375165 12.511218-38.973564 35.83776-10.815324 10.239361-67.419786 62.844072 48.63696 52.348728 36.701706-33.27792 1.983876 5.695644 3.423786 10.23936c53.948628 149.494657 183.412537 259.375789 341.13068 284.398225l2.463846 0.31998v-75.099306a362.505343 362.505343 0 0 1-271.631023-225.361915l-0.831948-2.463846z" p-id="5535" fill="#7FFFFF"></path></svg>
          重置抽奖
        </div>
        <div class="extra-item">
          <svg t="1705998858890" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6866" width="48" height="48"><path d="M62.360791 138.133034l150.266375 0 0 150.192697-150.266375 0 0-150.192697Z" p-id="6867" fill="#7FFFFF"></path><path d="M362.820887 138.133034l596.895529 0 0 150.192697-596.895529 0 0-150.192697Z" p-id="6868" fill="#7FFFFF"></path><path d="M62.360791 438.08864l150.266375 0 0 150.193721-150.266375 0 0-150.193721Z" p-id="6869" fill="#7FFFFF"></path><path d="M362.820887 438.08864l596.895529 0 0 150.193721-596.895529 0 0-150.193721Z" p-id="6870" fill="#7FFFFF"></path><path d="M62.360791 735.7459l150.266375 0 0 150.192697-150.266375 0 0-150.192697Z" p-id="6871" fill="#7FFFFF"></path><path d="M362.820887 735.7459l596.895529 0 0 150.192697-596.895529 0 0-150.192697Z" p-id="6872" fill="#7FFFFF"></path></svg>
          查看名单
        </div>
        <div class="extra-item">
          <svg t="1705998910973" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8758" width="48" height="48"><path d="M892.5 879.2h-761c-18.4 0-33.3-14.9-33.3-33.3V679.5c0-18.4 14.9-33.3 33.3-33.3h30c18.4 0 33.3 14.9 33.3 33.3 0 4.5-0.9 8.9-2.6 12.8l-13 64.8c0 18.4 14.9 33.3 33.3 33.3h599c18.4 0 33.3-14.9 33.3-33.3l-13-64.8c-1.7-3.9-2.6-8.3-2.6-12.8 0-18.4 14.9-33.3 33.3-33.3h30c18.4 0 33.3 14.9 33.3 33.3v166.4c0 18.4-14.9 33.3-33.3 33.3z m-66.6-500.3v0.6c2.6 1.1 4.4 3.7 4.4 6.7s-1.8 5.6-4.4 6.7v0.4L520.7 706.1h-0.4c-1.1 2.6-3.7 4.4-6.7 4.4s-5.6-1.8-6.7-4.4h-0.4L201.4 393.2v-0.4c-2.6-1.1-4.4-3.7-4.4-6.7s1.8-5.6 4.4-6.7v-0.6h-13.9 207v-51c0-18.4 14.9-33.3 33.3-33.3h168.6c18.4 0 33.3 14.9 33.3 33.3v51H840h-14.1z m-224-115.4H422.1c-15.3 0-27.7-12.4-27.7-27.7s12.4-27.7 27.7-27.7h179.7c15.3 0 27.7 12.4 27.7 27.7s-12.3 27.7-27.6 27.7z m11-84.3H411.1c-9.2 0-16.6-7.5-16.6-16.6 0-9.2 7.5-16.6 16.6-16.6H613c9.2 0 16.6 7.5 16.6 16.6 0 9.2-7.5 16.6-16.7 16.6z" fill="#7FFFFF" p-id="8759"></path></svg>
          导出名单
        </div>
      </div>
    </section>
    <section id="show-extra-panel">
      <svg t="1705997969803" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4385" id="mx_n_1705997969804" width="48" height="48"><path d="M400.896 261.156571l20.041143-100.205714A18.285714 18.285714 0 0 1 438.857143 146.285714h146.285714a18.285714 18.285714 0 0 1 17.92 14.701715l20.041143 100.169142c17.846857 7.899429 34.779429 17.700571 50.541714 29.220572l96.804572-32.768a18.285714 18.285714 0 0 1 21.686857 8.192l73.142857 126.683428a18.285714 18.285714 0 0 1-3.766857 22.893715l-76.763429 67.474285a277.211429 277.211429 0 0 1 0 58.294858l76.8 67.474285a18.285714 18.285714 0 0 1 3.730286 22.893715l-73.142857 126.683428a18.285714 18.285714 0 0 1-21.686857 8.192l-96.804572-32.768c-15.762286 11.52-32.694857 21.321143-50.541714 29.220572l-20.041143 100.205714A18.285714 18.285714 0 0 1 585.142857 877.714286h-146.285714a18.285714 18.285714 0 0 1-17.92-14.701715l-20.041143-100.169142a273.993143 273.993143 0 0 1-50.541714-29.220572l-96.804572 32.768a18.285714 18.285714 0 0 1-21.686857-8.192l-73.142857-126.683428a18.285714 18.285714 0 0 1 3.766857-22.893715l76.763429-67.474285a277.211429 277.211429 0 0 1 0-58.294858l-76.8-67.474285a18.285714 18.285714 0 0 1-3.730286-22.893715l73.142857-126.683428a18.285714 18.285714 0 0 1 21.686857-8.192l96.804572 32.768c15.762286-11.52 32.694857-21.321143 50.541714-29.220572zM603.428571 512a91.428571 91.428571 0 1 0-182.857142 0 91.428571 91.428571 0 0 0 182.857142 0z m36.571429 0a128 128 0 1 1-256 0 128 128 0 0 1 256 0z m-205.165714-234.166857a18.285714 18.285714 0 0 1-11.117715 13.385143 237.421714 237.421714 0 0 0-58.697142 33.938285 18.285714 18.285714 0 0 1-17.188572 2.962286l-91.794286-31.085714-58.148571 100.754286 72.777143 63.963428a18.285714 18.285714 0 0 1 6.034286 16.310857 239.908571 239.908571 0 0 0 0 67.876572 18.285714 18.285714 0 0 1-6.034286 16.310857l-72.777143 63.963428L256 726.930286l91.794286-31.085715a18.285714 18.285714 0 0 1 17.188571 2.998858 237.421714 237.421714 0 0 0 58.697143 33.938285 18.285714 18.285714 0 0 1 11.154286 13.385143L453.851429 841.142857h116.297142l19.017143-94.976a18.285714 18.285714 0 0 1 11.117715-13.385143 237.421714 237.421714 0 0 0 58.697142-33.938285 18.285714 18.285714 0 0 1 17.188572-2.962286l91.794286 31.085714 58.148571-100.754286-72.777143-63.963428a18.285714 18.285714 0 0 1-6.034286-16.310857 239.908571 239.908571 0 0 0 0-67.876572 18.285714 18.285714 0 0 1 6.034286-16.310857l72.777143-63.963428L768 297.069714l-91.794286 31.085715a18.285714 18.285714 0 0 1-17.188571-2.998858 237.421714 237.421714 0 0 0-58.697143-33.938285 18.285714 18.285714 0 0 1-11.154286-13.385143L570.148571 182.857143h-116.297142l-19.017143 94.976z" fill="#7FFFFF" p-id="4386"></path></svg>
    </section>
    <script src="./js/star-bg.js"></script>
    <script src="./js/three.min.js"></script>
    <script src="./js/xlsx.min.js"></script>
    <script src="./js/prizes.js"></script>
    <script>
      // 2024 index 位置
      const YEARLY_INDEX = [
        18 * 5, 19 * 5, 20 * 5, 22 * 5, 23 * 5, 24 * 5, 26 * 5, 27 * 5, 28 * 5, 30 * 5, 32 * 5,
        37 * 5, 39 * 5, 41 * 5, 45 * 5, 47 * 5, 49 * 5,
        52 * 5, 53 * 5, 54 * 5, 56 * 5, 58 * 5, 60 * 5, 61 * 5, 62 * 5, 64 * 5, 65 * 5, 66 * 5,
        69 * 5, 73 * 5, 75 * 5, 77 * 5, 83 * 5,
        86 * 5, 87 * 5, 88 * 5, 90 * 5, 91 * 5, 92 *5, 94 * 5, 95 * 5, 96 * 5, 100 * 5
      ];
      // 显示的用户数量，这里是 119 个比较合适，可以随意更改，只要调整显示的方式就行
      const SHOW_LENGTH = 119;
      // 用户数据是否 READY
      let IS_USERSDATA_READY = false;
      // 用户数据
      const LOTTERY_DATA = {
        realUsers: [],
        users: [],
      }
      // 是否显示了奖品面板
      let PRIZE_PANEL_VISIBLE = false;
      // 当前进行到第几轮，这里开始有缓存了
      let CUR_STAGE = localStorage.getItem('CUR_STAGE') || 1;
      // 中奖人信息，也是有缓存的
      const WINNERS_LIST = localStorage.getItem('WINNERS_LIST') ? JSON.parse(localStorage.getItem('WINNERS_LIST')) : [];
    </script>
    <script>
      // 重置抽奖，重置所有缓存
      const resetLottery = document.querySelector('#reset-lottery');
      resetLottery.addEventListener('click', () => {
        localStorage.clear();
        location.reload();
      }, false);
      // 读取 Excel 文件，解析用户数据
      function initUsers() {
        fetch('users.xlsx')
        .then(response => response.arrayBuffer())
        .then(buffer => {
            /* 读取工作簿 */
            const workbook = XLSX.read(buffer, {type: 'buffer'});

            /* 获取工作簿的第一个工作表 */
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            /* 将工作表对象转换为JSON */
            // FIXME: 这里很重要，抽奖的结果必须使用真实的用户数据，而不是 mock 的数据，这样可以确保公正准确
            const realUsers = XLSX.utils.sheet_to_json(worksheet);
            console.log('Real users: ', realUsers);
            // 保存真实的用户数据
            LOTTERY_DATA.realUsers = realUsers;
            // 如果表格数据不够，就用原来的数据补充满，如果表格数据太多，就截取前面的 119 数据
            // TODO: 这里现在默认的是用户数量肯定是 119 的一半还要多，所以只需要 mock 一个数量差就行了
            const mockUsers = realUsers.length >= SHOW_LENGTH ? realUsers.slice(0, SHOW_LENGTH) : [...realUsers, ...realUsers.slice(0, SHOW_LENGTH - realUsers.length)];
            const users = [];
            for (let i = 0; i < SHOW_LENGTH; i++) {
              const username = mockUsers[i]['姓名'];
              const emailprefix = mockUsers[i]['域账号'];
              const wkno = mockUsers[i]['工号'];
              // 行数
              const row = (i % 17) + 1;
              const column = Math.floor(i / 17) + 1;

              const element = [username, emailprefix, wkno, row, column];

              users.push(...element);
            }
            // 保存展示的用户数据
            LOTTERY_DATA.users = users;
            // 用户数据准备完毕
            IS_USERSDATA_READY = true;
        })
        .catch(error => console.error('Error reading the excel file:', error));
      }
      // 大幕开启的动画函数
      function openCurtains(winners) {
        const curtainContainer = document.getElementById('curtain');
        const curtainTop = document.getElementById('curtain-top');
        const curtainBottom = document.getElementById('curtain-bottom');
        const winContainer = document.getElementById('winners-container');
        
        // 大幕向上/向下移动的动画
        curtainContainer.style.opacity = 1;
        curtainTop.style.transform = 'translateY(-160px)';
        curtainBottom.style.transform = 'translateY(160px)';
        // 大幕透明度变化的动画
        winContainer.style.opacity = 0.9;

        // 可选：添加过渡效果使动画更平滑
        curtainTop.style.transition = 'transform 2s ease-out';
        curtainBottom.style.transition = 'transform 2s ease-out';
        // 控制 z-index，使得大幕在抽奖卡片上方
        winContainer.style.transition = 'opacity 1.5s ease-out';
        curtainContainer.style.transition = 'opacity 0.5s ease-out';

        // 添加中奖卡片
        const winnerList = document.querySelector('#winner-list');
        const winnerListFragment = document.createDocumentFragment();
        console.log('winners: ', winners);
        winners.forEach(winner => {
          const winnerCard = document.createElement('div');
          winnerCard.className = 'winner-card';
          winnerCard.innerHTML = `
            <div class="winner-card__info">
              <div class="winner-card__info__wkno">${winner["工号"]}</div>
              <div class="winner-card__info__username">${winner["姓名"]}</div>
              <div class="winner-card__info__emailprefix">${winner["域账号"]}</div>
            </div>`;
          winnerListFragment.appendChild(winnerCard);
        })
        winnerList.appendChild(winnerListFragment);
        // 显示名单的同时，把开始抽奖隐藏
        const lottery = document.querySelector('#lottery')
        setTimeout(() => {
          lottery.classList.remove('show', 'animate__animated', 'animate__bounceInUp');
          lottery.classList.add('hide');
        }, 2200);
      }

      // 大幕关闭的动画函数
      function resetCurtains() {
        const curtainContainer = document.getElementById('curtain');
        const curtainTop = document.getElementById('curtain-top');
        const curtainBottom = document.getElementById('curtain-bottom');
        const winContainer = document.getElementById('winners-container');
        
        // 重置大幕的位置
        curtainTop.style.transform = 'translateY(0)';
        curtainBottom.style.transform = 'translateY(0)';
        winContainer.style.opacity = 0;
        curtainContainer.style.opacity = 0;
        setTimeout(() => {
          document.querySelector('#winner-list').innerHTML = '';
        }, 1000);
      }
      /**
       * 点击显示 Prize Panel
       **/
      const showPrizeIcon = document.querySelector('#show-prize-panel');
      showPrizeIcon.addEventListener('click', () => {
        PRIZE_PANEL_VISIBLE = true;
        showPrizeIcon.classList.add('hide');
        const prizePanel = document.querySelector('#prize-panel');
        prizePanel.classList.add('animate__animated', 'animate__fadeInLeftBig', 'showflex');
      }, false);
      /**
       * 点击显示 extra panel
       **/
      const showExtraIcon = document.querySelector('#show-extra-panel');
      showExtraIcon.addEventListener('click', () => {
        showExtraIcon.classList.add('hide');
        const extraPanel = document.querySelector('#extra-panel');
        extraPanel.classList.add('animate__animated', 'animate__fadeInRightBig', 'showflex');
      }, false);
      /**
       * 生成中奖人名单，反给前端用来展示当前轮次的中奖信息
       **/
      function generateWinners() {
        // 必须根据真实的用户来生成，这样才能保证公正
        const realUsers = LOTTERY_DATA.realUsers.filter(user => !WINNERS_LIST.find(winner => winner['域账号'] === user['域账号']));
        // 从抽奖轮次中获取需要几个人
        const prizeInfo = PRIZES_LIST.find(prize => prize.stage === CUR_STAGE);
        const { count, stage, name } = prizeInfo;
        // 从用户里随机选出指定数量的人
        const winners = [];
        for (let i = 0; i < count; i++) {
          const randomIndex = Math.floor(Math.random() * realUsers.length);
          const winner = realUsers[randomIndex];
          winners.push({
            ...winner,
            stage,
            name,
          });
          // 从用户列表中删除已经中奖的用户
          realUsers.splice(randomIndex, 1);
        }
        // 更新中奖人信息并存入缓存
        WINNERS_LIST.push(...winners);
        localStorage.setItem('WINNERS_LIST', JSON.stringify([...WINNERS_LIST, ...winners]));
        return winners;
      }
      /**
       * 更新轮次信息
       **/
      function updateStageInfo() {
        const prizeInfo = PRIZES_LIST.find(prize => prize.stage === CUR_STAGE);
        const { count, name, image, stage } = prizeInfo;
        // 更新对应的内容
        const prizeName = document.querySelector('#prize-name');
        const prizeCount = document.querySelector('#prize-count');
        const prizeStage = document.querySelector('#prize-stage');
        const prizeImg = document.querySelector('#prize-img');
        prizeName.textContent = name;
        prizeCount.textContent = `数量: ${count}个`;
        prizeStage.textContent = `第${stage}轮`;
        prizeImg.src = image;
      }
      /**
       * 初始化页面
       **/
      window.onload = function () {
        // 初始化标题和抽奖按钮
        const title = document.querySelector('.title');
        const lottery = document.querySelector('#lottery')
        setTimeout(() => {
          title.classList.add('show', 'animate__animated', 'animate__bounceInDown');
          lottery.classList.add('show', 'animate__animated', 'animate__bounceInUp');
        }, 2200);
        // 初始化用户数据
        initUsers();
      };
    </script>
    <script type="module">
      /**
       * 初始化引入所有依赖
       **/
      import { CSS3DRenderer, CSS3DObject } from "./js/CSS3DRenderer.js";
      import { TrackballControls } from "./js/TrackballControls.js";
      import TWEEN from "./js/tween.module.js";

      /**
       * @空间复杂度  S(n) = o(1);
       * @时间复杂度  T(n) = O(1);
       */

      /**
       * [users 用户数据]
       * @type {Array}
       * @element 五个一组 [ 姓名 英文 工号 所在列 所在行 ]
       * @element 五个一组 [ symbol detail1 detail2 columnInfo colInfo ]
       *
       * [ scene camera renderer ] the three basic component of three.js
       * [ controls trackballControls obj ]
       *
       * [objects save CSS3D domElem]
       * @type {Array}
       * scene - 环境对象
       * camera - 相机对象
       * renderer - 渲染器对象
       * controls - 轨道控制器对象
       * [targets save the four kinds vertices]
       * @type {Object}
       * [ table sphere helix grid ] transform CSS3D elem'position to one of these for animation
       */
      let scene, camera, renderer, controls;
      // 保存 CSS3D 所有的 domElem
      const objects = [];
      // 保存四种形式的 Objects3D 对象信息
      const targets = {
        grid: [],
        helix: [],
        table: [],
        sphere: [],
      };

      /**
       * 布局方式
       */
      const LAYOUT_MODE = {
        表格: "table",
        网格: "grid",
        球体: "sphere",
        螺旋: "helix",
      }
      // 初始化布局
      let curLayout = LAYOUT_MODE.表格;
      // 是否在抽奖中
      let isLottery = false;

      /**
       * [init initialize scene && create animation && set constrol]
       *
       * [camera perspective camera]
       * @param filedView
       * @param aspect
       * @param near clipping plane
       * @param far clipping plane
       * @type {THREE}
       *
       * [renderer CSS3DRenderer only used to tranform domElem to 3D model]
       * WebGLoutput the father node of domElem container
       * @type {THREE}
       *
       * [controls create trackball control]
       * controls.minDistance = 500;  the camera min distance in Z Axis
       * controls.maxDistance = 6000; the camera max distance in Z Axis
       * @type {THREE}
       */

      function init() {
        const felidView = 40;
        const width = window.innerWidth;
        const height = window.innerHeight;
        const aspect = width / height;
        const nearPlane = 1;
        const farPlane = 1000;
        const WebGLoutput = document.getElementById("container");

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          felidView,
          aspect,
          nearPlane,
          farPlane
        );
        camera.position.z = 3000;

        console.log('camera.position: ', camera.position);

        renderer = new CSS3DRenderer();
        renderer.setSize(width, height);
        renderer.domElement.style.position = "absolute";
        WebGLoutput.appendChild(renderer.domElement);

        controls = new TrackballControls(camera, renderer.domElement);

        controls.rotateSpeed = 1;
        controls.staticMoving = true;
        controls.minDistance = 500;
        controls.maxDistance = 6000;
        controls.addEventListener("change", render);

        /**
         * [i 0 5 10 .....]
         * [len iterator count]
         * @type {Number}
         *
         * [element dom element]
         * [backgroundColor create a random color of g from 0.25 to 0.75]
         *
         * [number order]
         * @type {[int]}
         *
         * [symbol example: H element]
         * @type {[string]}
         *
         * [detail fullname && quality]
         * @type {[string && float]}
         *
         *[object transform domElem to CSS3D object]
         * @type {THREE}
         * @position vector3( value1, value2, value3 ) [value: -2000 ~ 2000]
         *
         */
        // 生成 118 个元素，这里需要根据用户数量 * 5 来生成，因为每个用户占据 5 个元素长度
        for (let i = 0; i < SHOW_LENGTH * 5; i += 5) {
          const element = document.createElement("div");
          element.className = YEARLY_INDEX.includes(i) ? 'element yearly'  : "element";
          element.style.backgroundColor = YEARLY_INDEX.includes(i) ? `rgba(253, 105, 0, ${
            Math.random() * 0.25 + 0.6
          }` : `rgba( 0, 127, 127, ${
            Math.random() * 0.5 + 0.25
          })`;

          const number = document.createElement("div");
          // 用户 id
          number.className = "wkno";
          number.textContent = LOTTERY_DATA.users[i + 2];
          element.appendChild(number);

          const symbol = document.createElement("div");
          // 中文名
          symbol.className = "username";
          symbol.textContent = LOTTERY_DATA.users[i];
          element.appendChild(symbol);

          const detail = document.createElement("div");
          // 邮箱前缀
          detail.className = "emailprefix";
          detail.innerHTML = LOTTERY_DATA.users[i + 1];
          element.appendChild(detail);
          const object = new CSS3DObject(element);
          object.position.x = Math.random() * 4000 - 2000;
          object.position.y = Math.random() * 4000 - 2000;
          object.position.z = Math.random() * 4000 - 2000;
          scene.add(object);

          objects.push(object);
        }

        const objLength = objects.length;

        createGridVertices();
        createTableVertices();
        createHelixVertices();
        createSphereVertices();

        /**
         * 生成排列的表格元素
         * @type {[number]}
         *
         * [createTableVertices create table format vertices]
         *
         * [createTableVertices create sphere format vertices]
         *
         * [createTableVertices create helix format vertices]
         *
         * [createTableVertices create grid format vertices]
         */
        // 生成 table 格式的元素
        function createTableVertices() {
          let i = 0;

          for (; i < SHOW_LENGTH * 5; i += 5) {
            const object = new THREE.Object3D();
            /**
             * 如果想变宽变高，可以通过修改这里的 160 和 200，但是需要修改 CSS 中的 .element 的宽高现在是（140 和 180）
             **/
            object.position.x = LOTTERY_DATA.users[i + 3] * 160 - 1360;
            object.position.y = -LOTTERY_DATA.users[i + 4] * 200 + 800;
            object.position.z = 0;

            targets.table.push(object);
          }
        }

        function createSphereVertices() {
          let i = 0;
          const vector = new THREE.Vector3();

          for (; i < objLength; ++i) {
            let phi = Math.acos(-1 + (2 * i) / objLength);
            let theta = Math.sqrt(objLength * Math.PI) * phi;
            const object = new THREE.Object3D();

            object.position.x = 800 * Math.cos(theta) * Math.sin(phi);
            object.position.y = 800 * Math.sin(theta) * Math.sin(phi);
            object.position.z = -800 * Math.cos(phi);

            // rotation object

            vector.copy(object.position).multiplyScalar(2);
            object.lookAt(vector);
            targets.sphere.push(object);
          }
        }

        function createHelixVertices() {
          let i = 0;
          const vector = new THREE.Vector3();

          for (; i < objLength; ++i) {
            let phi = i * 0.213 + Math.PI;

            const object = new THREE.Object3D();

            object.position.x = 800 * Math.sin(phi);
            object.position.y = -(i * 8) + 500;
            object.position.z = 800 * Math.cos(phi + Math.PI);

            object.scale.set(1.1, 1.1, 1.1);

            vector.x = object.position.x * 2;
            vector.y = object.position.y;
            vector.z = object.position.z * 2;

            object.lookAt(vector);

            targets.helix.push(object);
          }
        }

        function createGridVertices() {
          let i = 0;

          for (; i < objLength; ++i) {
            const object = new THREE.Object3D();

            object.position.x = 360 * (i % 5) - 800;
            object.position.y = -360 * (((i / 5) >> 0) % 5) + 700;
            object.position.z = -700 * ((i / 25) >> 0);

            targets.grid.push(object);
          }
        }

        // 开始抽奖按钮
        const lotteryBtn = document.getElementById("lottery");
        // 关闭中奖名单按钮
        const closeWinnerListBtn = document.getElementById("close-winner-list");

        // 关闭中奖名单
        closeWinnerListBtn.addEventListener('click', () => {
          // 把开始抽奖放出来
          const lottery = document.querySelector('#lottery')
          setTimeout(() => {
            lottery.classList.remove('hide');
            lottery.classList.add('show', 'animate__animated', 'animate__bounceInUp');
          }, 2200);
          // 重置大幕
          resetCurtains();
          // 重新回到 table 页面
          curLayout = LAYOUT_MODE.表格;
          transform(targets.table, 1000);
          camera.position.z = 3000;
          // 更新轮次
          CUR_STAGE += 1;
          // 更新缓存轮次
          localStorage.setItem("CUR_STAGE", CUR_STAGE);
          updateStageInfo();
        }, false);

        /**
         * 给开始抽奖绑定点击事件，点击后开始抽奖
         * 抽奖过程中文案变成 停！
         * 抽奖结束后，文案变成 开始抽奖
         **/
        lotteryBtn.addEventListener(
          "click",
          function () {
            if (!PRIZE_PANEL_VISIBLE) {
              // 如果没显示，那么就显示
              document.querySelector('#show-prize-panel').click();
            }
            if (isLottery) {
              // 停止抽奖
              isLottery = false;
              lotteryBtn.textContent = "开始抽奖";
              // 停止抽奖的逻辑，让所有元素停止旋转
              stopSphereAnimation();
              // 随机生成中奖人名单
              const winners = generateWinners();
              // 然后渲染获奖名单
              openCurtains(winners);
            } else {
              // 开始抽奖
              lotteryBtn.textContent = "停";
              isLottery = true;
              // 开始抽奖的逻辑，让所有元素开始旋转
              startSphereAnimation();
            }
          },
          false
        );

        // 球体动画相关参数
        let ang = 0;
        let timer;

        /**
         * 开始进行球体旋转
         **/
        function startSphereAnimation() {
          curLayout = LAYOUT_MODE.球体;
          transform(targets.sphere, 2000);
          // TODO: 这里处理相机旋转以及停止旋转，并封装一下
          setTimeout(() => {
            timer = setInterval(() => {
              // 旋转相机位置，球体就旋转了
              ang += Math.PI / 50;
              camera.position.x = Math.cos(ang) * 3000;
              camera.position.z = Math.sin(ang) * 3000;
              camera.position.y = 0;
            }, 10);
          }, 2600);
        }

        /**
         * 停止球体旋转
         **/
        function stopSphereAnimation() {
          clearInterval(timer);
          // 定义相机的起始和结束位置
          var endPos = {
            x: 0,
            y: 0,
            z: 4600
          };

          // 创建新的 tween 对象，用于从 start 到 end
          new TWEEN.Tween(camera.position)
            .to(endPos, 2000) // 持续时间 2000 毫秒
            .easing(TWEEN.Easing.Cubic.Out) // 缓动类型
            .start();

          new TWEEN.Tween(this)
            .to({}, 1000 * 2)
            .onUpdate(render)
            .start()
            .onComplete(() => {
              // 重置旋转角度
              ang = 0;
            });
        }

        // 如果是表格布局，就随机替换，如果不是就不动
        function updateRandomElements(numElementsToUpdate) {
          if (curLayout !== LAYOUT_MODE.表格) return;
          // 为了随机更新，创建一个包含所有索引的数组
          const indices = [];
          for (let i = 0; i < objects.length; i++) {
            indices.push(i);
          }

          // 随机选择要更新的元素的索引
          const indicesToUpdate = [];
          for (let i = 0; i < numElementsToUpdate; i++) {
            const randomIndex = Math.floor(Math.random() * indices.length);
            indicesToUpdate.push(indices.splice(randomIndex, 1)[0]);
          }

          // 更新选定的元素
          indicesToUpdate.forEach((ind) => {
            // 随机获取一个用户数据，按照 5 来取模，是因为每个用户数据占用 5 个元素
            const _index  = 5 * Math.floor(Math.random() * 50);
             // TODO: 需要实现获取用户数据的逻辑
            const userData = [LOTTERY_DATA.users[_index], LOTTERY_DATA.users[_index + 1], LOTTERY_DATA.users[_index + 2], LOTTERY_DATA.users[_index + 3], LOTTERY_DATA.users[_index + 4]];
            const element = objects[ind].element;
            // 更新element的内容
            // 例如，更新用户名称和其他信息
            // TODO: 这里只替换了用户名，其他的后续真实数据再进行替换
            element.querySelector('.username').textContent = userData[0];
            element.querySelector('.emailprefix').textContent = userData[1];
            element.querySelector('.wkno').textContent = userData[2];
            // ... 更新其他需要的DOM元素
            // 更新元素内容的同时，添加高亮动画
            element.classList.add('highlight');

            // 设置一个定时器，在1秒后移除高亮类
            setTimeout(() => {
              element.classList.remove('highlight');
            }, 1000);
          });

          // 重新渲染场景
          renderer.render(scene, camera);
        }

        // 设置定时器周期性调用 updateRandomElements 函数

        window.addEventListener("resize", onWindowResize, false);
        // default animation
        transform(targets.table, 2000);
        // 等所有布局都完成之后，再开始随机更新
        setTimeout(() => {
          // 每 10 秒随机更新 10 个元素的内容和位置
          setInterval(() => updateRandomElements(26), 1000);
        }, 3000);

        /**
         * [transform transform domelem'position to target'position]
         * @param     {[array]}    targets  [description]
         * @param     {[number]}    duration [description]
         * @return    {[type]}             [description]
         */

        function transform(targets, duration) {
          TWEEN.removeAll();

          for (let i = 0; i < objLength; ++i) {
            let object = objects[i];
            let target = targets[i];

            new TWEEN.Tween(object.position)
              .to(
                {
                  x: target.position.x,
                  y: target.position.y,
                  z: target.position.z,
                },
                Math.random() * duration + duration
              )
              .easing(TWEEN.Easing.Exponential.InOut)
              .start();

            new TWEEN.Tween(object.rotation)
              .to(
                {
                  x: target.rotation.x,
                  y: target.rotation.y,
                  z: target.rotation.z,
                },
                Math.random() * duration + duration
              )
              .easing(TWEEN.Easing.Exponential.InOut)
              .start();
          }

          // 这个补间用来在位置与旋转补间同步执行，通过onUpdate在每次更新数据后渲染scene和camera
          new TWEEN.Tween({})
            .to({}, duration * 2)
            .onUpdate(render)
            .start();
        }

        render();
      }

      /**
       * [onWindowResize reset the scene size && camera.aspect && re render]
       * @return
       */
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
        render();
      }

      /**
       * [animation update all tween && controls]
       */
      function animation() {
        TWEEN.update();
        controls.update();
        requestAnimationFrame(animation);
      }

      function render() {
        renderer.render(scene, camera);
      }

      // 循环判断用户数据是否 READY
      let dataTimer;
      dataTimer = setInterval(() => {
        // 如果已经准备好了
        if (IS_USERSDATA_READY) {
          console.log('用户数据已经准备好了');
          init();
          animation();
          clearInterval(dataTimer);
        }
      }, 200);
    </script>
  </body>
</html>
